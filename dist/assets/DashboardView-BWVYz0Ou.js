import{a as N,_ as z,o as n,c as d,b as s,t as c,w as k,v as O,d as L,F as C,r as x,n as y,e as h,u as P,f as T,g as as,h as E,i as os,j as is,k as j,l as f,m as rs,p as ls,q as G}from"./index-crUL-HRR.js";import{c as R,_ as ns,t as ds}from"./ConfirmarModal-Bry3jk8Q.js";const B={async getAll(){try{return{success:!0,data:(await N.get("/proyectos")).data}}catch(o){return{success:!1,error:o.response?.data?.mensaje||"Error al obtener proyectos"}}},async create(o){try{return{success:!0,data:(await N.post("/proyectos",o)).data}}catch(e){return{success:!1,error:e.response?.data?.mensaje||"Error al crear el proyecto"}}},async delete(o){try{return{success:!0,data:(await N.delete(`proyectos/${o}`)).data}}catch(e){return{success:!1,error:e.response?.data?.mensaje||"Error al eliminar"}}},update:async(o,e)=>{try{return(await N.put(`/proyectos/${o}`,e)).data}catch(p){throw p}}},cs={props:{proyectoOriginal:{type:Object,required:!0},todasLasTareas:{type:Array,default:()=>[]}},data(){return{form:{...this.proyectoOriginal,escuela_id:this.proyectoOriginal.escuela_id},estadosProyecto:[],prioridades:[],miembrosAsignados:[],busqueda:"",resultadosBusqueda:[]}},computed:{esAdminOOwner(){const e=P().usuario;return e&&(Number(e.rol_id)===1||Number(e.id)===Number(this.proyectoOriginal?.docente_owner_id))},leyendaPrioridades(){return!this.prioridades||this.prioridades.length===0?"Cargando escala de puntos...":`Puntos por tarea (según importancia):
${this.prioridades.map(e=>`• ${e.nombre}: ${e.peso} pts`).join(`
`)}

(Solo suma tareas en 'In Progress' o 'Testing')`}},async mounted(){await this.cargarConfiguraciones(),this.prepararMiembros()},methods:{async cargarConfiguraciones(){try{const o=await R.getTablasMaestras();this.estadosProyecto=o.estadosProyecto||[],this.prioridades=o.prioridades||[]}catch(o){console.error("Error cargando configuraciones en modal:",o)}},prepararMiembros(){const o=this.proyectoOriginal?.integrantes||this.proyectoOriginal?.Usuarios||[];this.miembrosAsignados=o.map(e=>({...e}))},calcularPuntos(o){return this.todasLasTareas.length?this.todasLasTareas.filter(e=>Number(e.responsable_id)===Number(o)&&(Number(e.estado_id)===2||Number(e.estado_id)===3)).reduce((e,p)=>{const m=this.prioridades.find(u=>u.id===p.prioridad_id);return e+(m?Number(m.peso):0)},0):0},getColorCarga(o){return o>=100?"is-danger-badge":o>=50?"is-warning-badge":"is-success-badge"},obtenerColorAvatar(o){return Number(o)===3?"has-background-success-light has-text-success":"has-background-link-light has-text-link"},obtenerIniciales(o){return o?o.split(" ").map(e=>e[0]).join("").toUpperCase().substring(0,2):"?"},quitarMiembro(o){this.miembrosAsignados=this.miembrosAsignados.filter(e=>e.id!==o)},async buscarUsuarios(){if(this.busqueda.length<2){this.resultadosBusqueda=[];return}try{const o=P(),e=await T.get(`/api/usuarios?q=${this.busqueda}`,{headers:{Authorization:`Bearer ${o.token}`}}),p=Number(this.proyectoOriginal.escuela_id);this.resultadosBusqueda=e.data.filter(m=>{if(Number(m.rol_id)!==3)return!0;const a=(m.usuario_escuelas||m.UsuarioEscuelas||m.Escuelas||m.escuelas||[]).some(_=>Number(_.escuela_id||_.id)===p),g=Number(m.escuela_id||m.escuelaId)===p;return a||g})}catch(o){console.error("Error en la búsqueda:",o)}},seleccionarUsuario(o){this.miembrosAsignados.some(e=>e.id===o.id)||(this.miembrosAsignados.push({...o}),this.busqueda="",this.resultadosBusqueda=[])},async confirmarCambios(){try{const o=P();await T.put(`/api/proyectos/${this.form.id}`,{...this.form,usuariosIds:this.miembrosAsignados.map(e=>e.id)},{headers:{Authorization:`Bearer ${o.token}`}}),this.$emit("actualizado"),this.$emit("close")}catch{alert("Error al guardar.")}}}},us={class:"modal is-active"},ms={class:"modal-card modal-grande"},bs={class:"modal-card-head has-background-primary"},ps={class:"modal-card-title has-text-white is-size-5-mobile"},hs={class:"modal-card-body p-5"},fs={class:"columns is-multiline"},gs={class:"column is-12-mobile is-4-tablet border-right-tablet"},vs={class:"field mb-4"},_s={class:"control"},ys={class:"tags has-addons"},ks={class:"tag is-info is-light is-medium has-text-weight-bold"},ws={class:"field mb-4"},Cs=["disabled"],xs={class:"field mb-4"},As={class:"select is-fullwidth"},$s=["disabled"],Ns=["value"],Es={class:"column is-12-mobile is-8-tablet"},Ps={class:"is-flex is-justify-content-between is-align-items-center border-bottom mb-2"},Os={class:"title is-6 has-text-grey uppercase-label mb-0"},qs=["data-tooltip"],Ms={class:"miembros-scroll-area mb-4"},Is={class:"columns is-multiline is-mobile px-2"},Ss={class:"box p-3 mb-0 is-shadowless border-slack"},Us={class:"media is-align-items-center"},Ds={class:"media-left mr-3"},js={class:"media-content"},Bs={class:"is-size-6 mb-0 has-text-weight-bold"},Vs={class:"is-size-7 has-text-grey"},Ts={class:"media-right is-flex is-align-items-center"},Gs=["onClick"],zs={key:0,class:"field mt-2 buscador-relativo"},Ls={class:"control has-icons-left"},Rs={key:0,class:"box is-paddingless mt-1 search-results-down"},Fs={class:"menu"},Ys={class:"menu-list"},Hs=["onClick"],Js={class:"is-flex is-justify-content-between is-align-items-center"},Ks={class:"has-text-link"},Qs={class:"modal-card-foot is-justify-content-flex-end p-4"};function Ws(o,e,p,m,u,l){return n(),d("div",us,[s("div",{class:"modal-background",onClick:e[0]||(e[0]=a=>o.$emit("close"))}),s("div",ms,[s("header",bs,[s("p",ps,"Gestionar Proyecto: "+c(p.proyectoOriginal.nombre),1),s("button",{class:"delete","aria-label":"close",onClick:e[1]||(e[1]=a=>o.$emit("close"))})]),s("section",hs,[s("div",fs,[s("div",gs,[e[12]||(e[12]=s("h3",{class:"title is-6 border-bottom has-text-grey uppercase-label"},"Información General",-1)),s("div",vs,[e[9]||(e[9]=s("label",{class:"label is-small"},"Escuela",-1)),s("div",_s,[s("div",ys,[e[8]||(e[8]=s("span",{class:"tag is-dark is-medium"},[s("i",{class:"fas fa-school"})],-1)),s("span",ks,c(p.proyectoOriginal.escuela?.nombre_corto||"Global"),1)])])]),s("div",ws,[e[10]||(e[10]=s("label",{class:"label is-small"},"Nombre del Proyecto",-1)),k(s("input",{class:"input",type:"text","onUpdate:modelValue":e[2]||(e[2]=a=>u.form.nombre=a),disabled:!l.esAdminOOwner},null,8,Cs),[[O,u.form.nombre]])]),s("div",xs,[e[11]||(e[11]=s("label",{class:"label is-small"},"Estado Global",-1)),s("div",As,[k(s("select",{"onUpdate:modelValue":e[3]||(e[3]=a=>u.form.estado_id=a),disabled:!l.esAdminOOwner},[(n(!0),d(C,null,x(u.estadosProyecto,a=>(n(),d("option",{key:a.id,value:a.id},c(a.nombre),9,Ns))),128))],8,$s),[[L,u.form.estado_id]])])])]),s("div",Es,[s("div",Ps,[s("h3",Os," Integrantes ("+c(u.miembrosAsignados.length)+") ",1),s("span",{class:"icon has-text-info is-clickable help-tooltip-down","data-tooltip":l.leyendaPrioridades},[...e[13]||(e[13]=[s("i",{class:"fas fa-info-circle"},null,-1)])],8,qs)]),s("div",Ms,[s("div",Is,[(n(!0),d(C,null,x(u.miembrosAsignados,a=>(n(),d("div",{class:"column is-12 p-1",key:a.id},[s("div",Ss,[s("article",Us,[s("figure",Ds,[s("div",{class:y(["avatar-circle-lg",l.obtenerColorAvatar(a.rol_id)])},c(l.obtenerIniciales(a.nombre)),3)]),s("div",js,[s("p",Bs,c(a.apellido?a.apellido.toUpperCase()+", ":"")+c(a.nombre),1),s("p",Vs,[s("span",{class:y(["tag is-small is-light",Number(a.rol_id)===3?"is-info":"is-warning"])},c(Number(a.rol_id)===3?"Alumno":"Docente/Admin"),3)])]),s("div",Ts,[l.calcularPuntos(a.id)>0?(n(),d("div",{key:0,class:y(["workload-badge mr-3",l.getColorCarga(l.calcularPuntos(a.id))])},c(l.calcularPuntos(a.id)),3)):h("",!0),l.esAdminOOwner?(n(),d("button",{key:1,class:"button is-white is-small",onClick:g=>l.quitarMiembro(a.id)},[...e[14]||(e[14]=[s("span",{class:"icon has-text-danger"},[s("i",{class:"fas fa-user-minus"})],-1)])],8,Gs)):h("",!0)])])])]))),128))])]),l.esAdminOOwner?(n(),d("div",zs,[e[16]||(e[16]=s("label",{class:"label is-small"},"Asignar nuevo integrante",-1)),s("div",Ls,[k(s("input",{class:"input is-rounded",type:"text","onUpdate:modelValue":e[4]||(e[4]=a=>u.busqueda=a),onInput:e[5]||(e[5]=(...a)=>l.buscarUsuarios&&l.buscarUsuarios(...a)),placeholder:"Buscar por Apellido o Nombre..."},null,544),[[O,u.busqueda]]),e[15]||(e[15]=s("span",{class:"icon is-left"},[s("i",{class:"fas fa-search"})],-1)),u.resultadosBusqueda.length>0?(n(),d("div",Rs,[s("aside",Fs,[s("ul",Ys,[(n(!0),d(C,null,x(u.resultadosBusqueda,a=>(n(),d("li",{key:a.id},[s("a",{onClick:g=>l.seleccionarUsuario(a),class:"p-3 border-bottom-light"},[s("div",Js,[s("div",null,[s("strong",Ks,c(a.apellido?a.apellido.toUpperCase()+", ":"")+c(a.nombre),1)]),s("span",{class:y(["tag is-small",Number(a.rol_id)===3?"is-info is-light":"is-warning is-light"])},c(Number(a.rol_id)===3?"Alumno":"Docente/Admin"),3)])],8,Hs)]))),128))])])])):h("",!0)])])):h("",!0)])])]),s("footer",Qs,[s("button",{class:"button",onClick:e[6]||(e[6]=a=>o.$emit("close"))},"Cerrar"),l.esAdminOOwner?(n(),d("button",{key:0,class:"button is-success",onClick:e[7]||(e[7]=(...a)=>l.confirmarCambios&&l.confirmarCambios(...a))},[...e[17]||(e[17]=[s("span",null,"Guardar Cambios",-1)])])):h("",!0)])])])}const Xs=z(cs,[["render",Ws],["__scopeId","data-v-a189b9de"]]),Zs={class:"dashboard-bg"},se={class:"main-content-wrapper"},ee={class:"container mt-0 pt-6 px-4 pb-6"},te={class:"level mb-6"},ae={class:"level-right"},oe={key:0,class:"notification glass-notification is-info"},ie={key:1,class:"notification glass-notification is-danger"},re={key:2,class:"box glass-panel p-0"},le={class:"table is-fullwidth glass-table"},ne=["onClick"],de={class:"tag is-info post-it-tag"},ce={class:"has-text-white"},ue={class:"has-text-grey-lighter"},me={class:"tag is-success is-light is-rounded has-text-weight-bold"},be={class:"has-text-grey-light"},pe={class:"has-text-right"},he={key:0,class:"buttons is-right"},fe=["onClick"],ge=["onClick"],ve={key:0},_e={class:"footer-dashboard"},ye={class:"footer-container"},ke={class:"footer-credits"},we={class:"modal-card"},Ce={class:"modal-card-head"},xe={class:"modal-card-body"},Ae={class:"field"},$e={class:"control"},Ne={class:"select is-fullwidth"},Ee=["value"],Pe={class:"field"},Oe={class:"control"},qe={class:"field"},Me={class:"control"},Ie={class:"modal-card-foot is-justify-content-flex-end"},Se=["disabled"],Ue={__name:"DashboardView",setup(o){const e=P(),p=ls(),m=f([]),u=f([]),l=f(!1),a=f(""),g=f(!1),_=f(!1),b=rs({nombre:"",descripcion:"",escuela_id:null}),q=f(!1),M=f(null),I=f([]),A=f(!1),w=f(null),F=j(()=>new Date().getFullYear()),Y=j(()=>{const i=Number(e.usuario?.rol_id||e.usuario?.rolId);return i===1||i===2}),V=j(()=>{const i=e.usuario;if(!i)return[];const t=Number(i.id);return Number(i.rol_id||i.rolId)===1?m.value:m.value.filter(v=>{const S=Number(v.docente_owner_id)===t,U=(v.Usuarios||v.integrantes||v.usuarios||[]).some(D=>Number(D.id)===t);return S||U})}),H=i=>{const t=e.usuario;if(!t)return!1;const r=Number(t.id),v=Number(t.rol_id||t.rolId);if(v===1)return!0;if(v===2){const S=Number(i.docente_owner_id)===r,U=(i.Usuarios||i.integrantes||[]).some(D=>Number(D.id)===r);return S||U}return!1},J=i=>{p.push(`/proyectos/${i}/backlog`)},$=async()=>{l.value=!0,a.value="";try{const i=await B.getAll();i.success?m.value=i.data:a.value=i.error}catch{a.value="Error al conectar con el servidor"}finally{l.value=!1}},K=async()=>{try{const i=await R.getTablasMaestras();u.value=i.escuelas||[]}catch(i){console.error("Error al cargar escuelas:",i)}},Q=()=>{b.nombre="",b.descripcion="",b.escuela_id=null,g.value=!0},W=async i=>{M.value=i;try{const t=await ds.getAll();I.value=t.data||t}catch(t){console.error("Error cargando tareas globales:",t),I.value=[]}finally{q.value=!0}},X=async()=>{if(!(!b.nombre||!b.escuela_id)){_.value=!0;try{(await B.create(b)).success&&(g.value=!1,await $())}catch(i){console.error("Error guardando proyecto",i)}finally{_.value=!1}}},Z=i=>{w.value=i,A.value=!0},ss=async()=>{if(!w.value)return;const i=await B.delete(w.value.id);i.success?(A.value=!1,w.value=null,await $()):alert(i.error)},es=i=>i?new Date(i).toLocaleDateString("es-AR"):"-";return as(()=>{$(),K()}),(i,t)=>(n(),d("div",Zs,[s("div",se,[s("div",ee,[s("div",te,[t[9]||(t[9]=s("div",{class:"level-left"},[s("h1",{class:"title has-text-white is-2"},[s("span",{class:"icon mr-3"},[s("i",{class:"fas fa-chalkboard"})]),E(" Mis Proyectos ")])],-1)),s("div",ae,[Y.value?(n(),d("button",{key:0,class:"button is-info is-light has-text-weight-bold",onClick:Q},[...t[8]||(t[8]=[s("span",{class:"icon"},[s("i",{class:"fas fa-plus"})],-1),s("span",null,"Nuevo Proyecto",-1)])])):h("",!0)])]),l.value?(n(),d("div",oe,[...t[10]||(t[10]=[s("span",{class:"icon"},[s("i",{class:"fas fa-spinner fa-pulse"})],-1),E(" Cargando proyectos... ",-1)])])):h("",!0),a.value&&a.value.length>0?(n(),d("div",ie,c(a.value),1)):h("",!0),!l.value&&!a.value?(n(),d("div",re,[s("table",le,[t[14]||(t[14]=s("thead",null,[s("tr",null,[s("th",{class:"has-text-info"},"Escuela"),s("th",{class:"has-text-info"},"Nombre"),s("th",{class:"has-text-info"},"Descripción"),s("th",{class:"has-text-info"},"Estado"),s("th",{class:"has-text-info"},"Creado"),s("th",{class:"has-text-right has-text-info"},"Acciones")])],-1)),s("tbody",null,[(n(!0),d(C,null,x(V.value,r=>(n(),d("tr",{key:r.id,onClick:v=>J(r.id),class:"clickable-row"},[s("td",null,[s("span",de,c(r.escuela?.nombre_corto||"Global"),1)]),s("td",null,[s("strong",ce,c(r.nombre),1)]),s("td",ue,c(r.descripcion),1),s("td",null,[s("span",me,c(r.estado_proyecto?.nombre||"Sin estado"),1)]),s("td",be,c(es(r.created_at)),1),s("td",pe,[H(r)?(n(),d("div",he,[s("button",{class:"button is-small is-warning is-inverted",onClick:G(v=>W(r),["stop"])},[...t[11]||(t[11]=[s("span",{class:"icon is-small"},[s("i",{class:"fas fa-edit"})],-1)])],8,fe),s("button",{class:"button is-small is-danger is-inverted",onClick:G(v=>Z(r),["stop"])},[...t[12]||(t[12]=[s("span",{class:"icon is-small"},[s("i",{class:"fas fa-trash"})],-1)])],8,ge)])):h("",!0)])],8,ne))),128)),V.value.length===0?(n(),d("tr",ve,[...t[13]||(t[13]=[s("td",{colspan:"6",class:"has-text-centered has-text-grey-light py-6"},[s("i",{class:"fas fa-folder-open fa-3x mb-3"}),s("br"),E(" No tienes proyectos asignados actualmente. ")],-1)])])):h("",!0)])])])):h("",!0)])]),s("footer",_e,[s("div",ye,[t[15]||(t[15]=s("div",{class:"footer-info"},[E(" Gestión de Proyectos Estudiantiles "),s("span",{class:"version-badge"},"v1.0.3-stable")],-1)),s("div",ke," © "+c(F.value)+" | Creado por Ing. Guillermo Codina. Todos los derechos reservados. ",1),t[16]||(t[16]=s("div",{class:"footer-contact"},[s("span",{class:"icon"},[s("i",{class:"fas fa-envelope"})]),s("a",{href:"mailto:codinaguillermo@gmail.com"},"Contacto de Soporte")],-1))])]),s("div",{class:y(["modal",{"is-active":g.value}])},[s("div",{class:"modal-background",onClick:t[0]||(t[0]=r=>g.value=!1)}),s("div",we,[s("header",Ce,[t[17]||(t[17]=s("p",{class:"modal-card-title"},"Nuevo Proyecto",-1)),s("button",{class:"delete","aria-label":"close",onClick:t[1]||(t[1]=r=>g.value=!1)})]),s("section",xe,[s("div",Ae,[t[19]||(t[19]=s("label",{class:"label"},"Escuela Perteneciente",-1)),s("div",$e,[s("div",Ne,[k(s("select",{"onUpdate:modelValue":t[2]||(t[2]=r=>b.escuela_id=r)},[t[18]||(t[18]=s("option",{value:null},"Seleccionar Escuela...",-1)),(n(!0),d(C,null,x(u.value,r=>(n(),d("option",{key:r.id,value:r.id},c(r.nombre_corto)+" - "+c(r.nombre_largo),9,Ee))),128))],512),[[L,b.escuela_id]])])])]),s("div",Pe,[t[20]||(t[20]=s("label",{class:"label"},"Nombre del Proyecto",-1)),s("div",Oe,[k(s("input",{class:"input",type:"text","onUpdate:modelValue":t[3]||(t[3]=r=>b.nombre=r),placeholder:"Ej: App de Asistencia"},null,512),[[O,b.nombre]])])]),s("div",qe,[t[21]||(t[21]=s("label",{class:"label"},"Descripción",-1)),s("div",Me,[k(s("textarea",{class:"textarea","onUpdate:modelValue":t[4]||(t[4]=r=>b.descripcion=r),placeholder:"¿De qué se trata el proyecto?"},null,512),[[O,b.descripcion]])])])]),s("footer",Ie,[s("button",{class:y(["button is-success",{"is-loading":_.value}]),onClick:X,disabled:!b.escuela_id}," Guardar Proyecto ",10,Se),s("button",{class:"button",onClick:t[5]||(t[5]=r=>g.value=!1)},"Cancelar")])])],2),q.value?(n(),os(Xs,{key:M.value.id,proyectoOriginal:M.value,todasLasTareas:I.value,onClose:t[6]||(t[6]=r=>q.value=!1),onActualizado:$},null,8,["proyectoOriginal","todasLasTareas"])):h("",!0),is(ns,{isActive:A.value,mensaje:`¿Estás seguro de eliminar el proyecto '${w.value?.nombre}'? Se borrará todo el backlog asociado.`,onConfirmar:ss,onCancelar:t[7]||(t[7]=r=>A.value=!1)},null,8,["isActive","mensaje"])]))}},Be=z(Ue,[["__scopeId","data-v-eb72165b"]]);export{Be as default};
